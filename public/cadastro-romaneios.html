<!DOCTYPE html>
<html>
  <head>
    <title>CADASTRO ROMANEIOS</title>
    <script defer src="/__/firebase/9.6.6/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/9.6.6/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>
  </head>
  <body>

    <h2>ROMANEIO INDAIÁ</h2>
    <h4>Registro de Romaneio de Água Mineral 20L INDAIÁ</h4>

    <form method="post">

        <input id="id" type="hidden" />
        
        <label for="data">DATA/HORA:</label>
        <input id="data" name="data" type="date" /><br />

        <label for="placa">PLACA VEÍCULO:</label>
        <select id="placa" name="placa">
        <option id="hyd" value="HYD-2A18">HYD-2A18</option>
        <option id="jvw" value="JVW-7464">JVW-7464</option>
        </select> <br />

        <label for="itemA">(A) BOM PARA ENVASE:</label>
        <input id="itemA" name="A" type="number" min="0" /><br />

        <label for="itemB">(B) RETORNO VAZIO:</label>
        <input id="itemB" name="B" type="number" min="0" /><br />

        <label for="itemC">(C) ENTRADA CHEIO:</label>
        <input id="itemC" name="C" type="number" min="0" /><br />

        <label for="itemH">(H) TROCA (PERDA):</label>
        <input id="itemH" name="H" type="number" min="0" /><br />

        <label for="itemI">(I) CHEIO (À FATURAR):</label>
        <input id="itemI" name="I" type="number" min="0" /><br />

        <button type="button" onclick="gravarRomaneio()">gravar</button>
        <button type="button" onclick="excluirRomaneio()">excluir</button>

    </form>

    <br />

    <p id="resultado"></p>

    <script src="js/index.js"></script>

    <script>

      let id = null;

      document.addEventListener("DOMContentLoaded", function() {

        id = getUrlParameter("id");

        if(!!id) {
          
          carregarRomaneio();

        }

      })

      function gravarRomaneio() {

        const romaneio = {
          data: new Date(document.getElementById("data").value),
          placa: document.getElementById("placa").value,
          itemA: document.getElementById("itemA").value,
          itemB: document.getElementById("itemB").value,
          itemC: document.getElementById("itemC").value,
          itemH: document.getElementById("itemH").value,
          itemI: document.getElementById("itemI").value
        }

        if(!!id) {

          romaneio.id = id;
          atualizarDocumento("romaneios", romaneio);

        } else {

          criarDocumento("romaneios", romaneio, gerarIdRomaneio());

        }

      }

      function carregarRomaneio() {

        //console.log("id: "+id);
        carregarDocumentos("romaneios", id)
          .then((documentSnapshot) => {

            let romaneio = documentSnapshot.data();

            document.getElementById("id").value = id;
            document.getElementById("data").value = formatarData(romaneio.data, "us");
            document.getElementById("placa").value = romaneio.placa;
            document.getElementById("itemA").value = romaneio.itemA;
            document.getElementById("itemB").value = romaneio.itemB;
            document.getElementById("itemC").value = romaneio.itemC;
            document.getElementById("itemH").value = romaneio.itemH;
            document.getElementById("itemI").value = romaneio.itemI;

          })
          .catch((error) => {
            console.log("Erro no carregamento de documento: "+ error);
          });

      }

      function excluirRomaneio() {

        excluirDocumento("romaneios", id);

      }

      function gerarIdRomaneio() {

        let data = document.getElementById("data").value;
        let placa = document.getElementById("placa").value;
        let itemA = document.getElementById("itemA").value;
        let itemB = document.getElementById("itemB").value;
        let itemC = document.getElementById("itemC").value;
        let itemH = document.getElementById("itemH").value;
        let itemI = document.getElementById("itemI").value;

        return Date.parse(data)
          .toString()
          .slice(0,6)
          .concat(placa.replace('-',''),
          (!!eval(itemA)
          + !!eval(itemB)
          + !!eval(itemC)
          + !!eval(itemH)
          + !!eval(itemI)));

      }

    </script>

  </body>
</html>
