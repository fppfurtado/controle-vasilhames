<!DOCTYPE html>
<html>
  <head>
    <title>CADASTRO ROMANEIOS</title>
    <script defer src="/__/firebase/9.6.6/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/9.6.6/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>
  </head>
  <body>

    <h2>ROMANEIO INDAIÁ</h2>
    <h4>Registro de Romaneio de Água Mineral 20L INDAIÁ</h4>

    <form method="post">

        <input id="id" type="hidden" />
        
        <label for="data">DATA/HORA:</label>
        <input id="data" name="data" type="datetime-local" /><br />

        <label for="placa">PLACA VEÍCULO:</label>
        <select id="placa" name="placa">
        <option id="hyd" value="HYD-2A18">HYD-2A18</option>
        <option id="jvw" value="JVW-7464">JVW-7464</option>
        </select> <br />

        <label for="itemA">(A) BOM PARA ENVASE:</label>
        <input id="itemA" name="A" type="number" min="0" /><br />

        <label for="itemB">(B) RETORNO VAZIO:</label>
        <input id="itemB" name="B" type="number" min="0" /><br />

        <label for="itemC">(C) ENTRADA CHEIO:</label>
        <input id="itemC" name="C" type="number" min="0" /><br />

        <label for="itemH">(H) TROCA (PERDA):</label>
        <input id="itemH" name="H" type="number" min="0" /><br />

        <label for="itemI">(I) CHEIO (À FATURAR):</label>
        <input id="itemI" name="I" type="number" min="0" /><br />

        <button type="button" onclick="gravarRomaneio()">gravar</button>
        <button type="button" onclick="excluirRomaneio()">excluir</button>

    </form>

    <br />

    <p id="resultado"></p>

    <script src="js/index.js"></script>

    <script>

      let id = null;
      let dateInputValue = document.getElementById("data").value = getTodayDate().toISOString().slice(0,16);
      const romaneio = {
          data: null,
          placa: "",
          itemA: 0,
          itemB: 0,
          itemC: 0,
          itemH: 0,
          itemI: 0
        }

      document.addEventListener("DOMContentLoaded", function() {

        id = getUrlParameter("id");
        document.getElementById("data").value = dateInputValue;
        carregarInventario(new Date(dateInputValue));

        if(!!id) {
          
          carregarRomaneio();

        }

      })

      function gravarRomaneio() {

        romaneio.data = new Date(document.getElementById("data").value);
        romaneio.placa = document.getElementById("placa").value;
        romaneio.itemA = document.getElementById("itemA").value;
        romaneio.itemB = document.getElementById("itemB").value;
        romaneio.itemC = document.getElementById("itemC").value;
        romaneio.itemH = document.getElementById("itemH").value;
        romaneio.itemI = document.getElementById("itemI").value;

        if(!!id) {

          //romaneio.id = id;
          atualizarDocumento("romaneios", romaneio, id);

        } else {

          id = gerarIdRomaneio();
          criarDocumento("romaneios", romaneio);
          habilitarMonitoramentoDocumento("romaneios", id, (snapshot) => {
            console.log("ouvindo alteração romaneio...");
            // snapshot.docChanges().forEach((change) => {
            //   console.log("change:");
            //   console.log(change);

            // });
          })

        }

        registrarMovimento(id, "e");

      }

      function carregarRomaneio() {

        console.log("[CARREGAR ROMANEIO]");

        console.log("id: "+id);
        
        carregarDocumentos("romaneios", id)
          .then((documentSnapshot) => {

            let romaneio = documentSnapshot.data();

            document.getElementById("id").value = id;
            document.getElementById("data").value = formatarData(romaneio.data, "us");
            document.getElementById("placa").value = romaneio.placa;
            document.getElementById("itemA").value = romaneio.itemA;
            document.getElementById("itemB").value = romaneio.itemB;
            document.getElementById("itemC").value = romaneio.itemC;
            document.getElementById("itemH").value = romaneio.itemH;
            document.getElementById("itemI").value = romaneio.itemI;

          })
          .catch((error) => {
            console.log("Erro no carregamento de documento: "+ error);
          });

      }

      function excluirRomaneio() {

        excluirDocumento("romaneios", id);
        registrarMovimento(id, "s");

      }

      function gerarIdRomaneio() {

        let data = document.getElementById("data").value;
        let placa = document.getElementById("placa").value;
        let itemA = document.getElementById("itemA").value;
        let itemB = document.getElementById("itemB").value;
        let itemC = document.getElementById("itemC").value;
        let itemH = document.getElementById("itemH").value;
        let itemI = document.getElementById("itemI").value;

        return Date.parse(data)
          .toString()
          .slice(0,6)
          .concat(placa.replace('-',''),
          (!!eval(itemA)
          + !!eval(itemB)
          + !!eval(itemC)
          + !!eval(itemH)
          + !!eval(itemI)));

      }

      function registrarMovimento(romaneioId, tipoMovimento) {

        let movimento = {
          data: romaneio.data,
          origem: "romaneios/" + romaneioId,
          destino: romaneio.placa

        }

        if(tipoMovimento == "e") {

          // vasilhames cheios
          if(romaneio.itemI) {

            movimento.situacaoVasilhame = "c";
            movimento.qtdVasilhames = romaneio.itemI;
            criarDocumento("movimentos", movimento)
            .then((docRef) => {
              console.log("id movimento: "+docRef);
              movimento.id = docRef;
              habilitarMonitoramentoDocumento("movimentos", docRef, function() {
                console.log("listener movimento executnado");
                atualizarInventario(inventario, movimento);
              });  
            })
            
            //atualizarInventario(inventario, movimento);

          }

          // vasilhames vazios
          if(romaneio.itemB) {            
            movimento.situacaoVasilhame = "v";
            movimento.qtdVasilhames = romaneio.itemB;
            criarDocumento("movimentos", movimento)
            .then((docRef) => {
              console.log("id movimento: "+docRef);
              habilitarMonitoramentoDocumento("movimentos", docRef, function() {
                console.log("listener movimento executnado");
                atualizarInventario(inventario, movimento);
              });  
            })
            
            //atualizarInventario(inventario, movimento);
          }

          // vasilhames inutilizados (quebrados ou vencidos)
          if(romaneio.itemH) {            
            movimento.situacaoVasilhame = "i";
            movimento.qtdVasilhames = romaneio.itemH;
            criarDocumento("movimentos", movimento)
            .then((docRef) => {
              console.log("id movimento: "+docRef);
              habilitarMonitoramentoDocumento("movimentos", docRef, function() {
                console.log("listener movimento executnado");
                atualizarInventario(inventario, movimento);
              });  
            })
            
            //atualizarInventario(inventario, movimento);
          }

        } else {

          // vasilhames cheios
          if(romaneio.itemI) {
            movimento.situacaoVasilhame = "c";
            movimento.qtdVasilhames = -(romaneio.itemI);
            criarDocumento("movimentos", movimento)
            .then((docRef) => {
              console.log("id movimento: "+docRef);
              habilitarMonitoramentoDocumento("movimentos", docRef, function() {
                console.log("listener movimento executnado");
                atualizarInventario(inventario, movimento);
              });  
            })
            
            //atualizarInventario(inventario, movimento);
          }

          // vasilhames vazios
          if(romaneio.itemB) {            
            movimento.situacaoVasilhame = "v";
            movimento.qtdVasilhames = -(romaneio.itemB);
            criarDocumento("movimentos", movimento)
            .then((docRef) => {
              console.log("id movimento: "+docRef);
              habilitarMonitoramentoDocumento("movimentos", docRef, function() {
                console.log("listener movimento executnado");
                atualizarInventario(inventario, movimento);
              });  
            })
            
            //atualizarInventario(inventario, movimento);
          }

          // vasilhames inutilizados (quebrados ou vencidos)
          if(romaneio.itemH) {            
            movimento.situacaoVasilhame = "i";
            movimento.qtdVasilhames = -(romaneio.itemH);
            criarDocumento("movimentos", movimento)
            .then((docRef) => {
              console.log("id movimento: "+docRef);
              habilitarMonitoramentoDocumento("movimentos", docRef, function() {
                console.log("listener movimento executnado");
                atualizarInventario(inventario, movimento);
              });  
            })
            
            //atualizarInventario(inventario, movimento);
          }

        }

      }

    </script>

  </body>
</html>
