<!DOCTYPE html>
<html>
  <head>
    <title>CADASTRO ROMANEIOS</title>
    <script defer src="/__/firebase/9.6.6/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/9.6.6/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>
  </head>
  <body>

    <h2>ROMANEIO INDAIÁ</h2>
    <h4>Registro de Romaneio de Água Mineral 20L INDAIÁ</h4>

    <form method="post">

        <input id="id" type="hidden" />
        
        <label for="data">DATA/HORA:</label>
        <input id="data" name="data" type="datetime-local" /><br />

        <label for="placa">PLACA VEÍCULO:</label>
        <select id="placa" name="placa">
        <option id="hyd" value="HYD-2A18">HYD-2A18</option>
        <option id="jvw" value="JVW-7464">JVW-7464</option>
        </select> <br />

        <label for="itemA">(A) BOM PARA ENVASE:</label>
        <input id="itemA" name="A" type="number" min="0" /><br />

        <label for="itemB">(B) RETORNO VAZIO:</label>
        <input id="itemB" name="B" type="number" min="0" /><br />

        <label for="itemC">(C) ENTRADA CHEIO:</label>
        <input id="itemC" name="C" type="number" min="0" /><br />

        <label for="itemH">(H) TROCA (PERDA):</label>
        <input id="itemH" name="H" type="number" min="0" /><br />

        <label for="itemI">(I) CHEIO (À FATURAR):</label>
        <input id="itemI" name="I" type="number" min="0" /><br />

        <button type="button" onclick="gravarRomaneio()">gravar</button>
        <button type="button" onclick="excluirRomaneio()">excluir</button>

    </form>

    <br />

    <p id="resultado"></p>

    <script src="js/index.js"></script>

    <script>

      let id = null;
      let dateInputValue = document.getElementById("data").value = getTodayDate().toISOString().slice(0,16);
      const romaneio = {
        data: null,
        placa: null,
        quantidades: new Array(5),
        alterarQuantidade: function(situacaoVasilhame, qtd) {
            this.quantidades[situacaoVasilhame] = qtd;
        }
      }

      document.addEventListener("DOMContentLoaded", function() {

        id = getUrlParameter("id");
        document.getElementById("data").value = dateInputValue;
        carregarInventario(new Date(dateInputValue));

        if(!!id) {
          
          carregarRomaneio();

        }

      })

      function gravarRomaneio() {

        console.log("[GRAVAR ROMANEIO]");

        romaneio.id = id;
        romaneio.data = new Date(document.getElementById("data").value);
        romaneio.placa = document.getElementById("placa").value;
        romaneio.alterarQuantidade(situacaoVasilhames.BOM_PARA_ENVASE, document.getElementById("itemA").value);
        romaneio.alterarQuantidade(situacaoVasilhames.RETORNO_VAZIO, document.getElementById("itemB").value);
        romaneio.alterarQuantidade(situacaoVasilhames.ENTRADA_CHEIO, document.getElementById("itemC").value);
        romaneio.alterarQuantidade(situacaoVasilhames.TROCA_PERDA, document.getElementById("itemH").value);
        romaneio.alterarQuantidade(situacaoVasilhames.CHEIO_A_FATURAR, document.getElementById("itemI").value);

        delete romaneio.alterarQuantidade;

        console.log(romaneio);

        if(!!id) {

          //romaneio.id = id;
          atualizarDocumento("romaneios", romaneio, id)
          .then((docId) => {

            registrarMovimento(romaneio);

          })
     
        } else {

          //romaneio.id = gerarIdRomaneio();
          //romaneio.id = id;

          criarDocumento("romaneios", romaneio, gerarIdRomaneio())
          .then((docRef) => {

            habilitarMonitoramentoDocumento("romaneios", id, (snapshot) => {
              console.log("ouvindo alteração romaneio...");
            })

            registrarMovimento(romaneio);

          })
          
        }

        //registrarMovimento(id, tipoMovimento.ENTRADA);
        

      }

      function carregarRomaneio() {

        console.log("[CARREGAR ROMANEIO]");

        console.log("id: "+id);
        
        carregarDocumentos("romaneios", id)
          .then((documentSnapshot) => {

            let romaneio = documentSnapshot.data();

            document.getElementById("id").value = id;
            document.getElementById("data").value = formatarData(romaneio.data, "us");
            document.getElementById("placa").value = romaneio.placa;
            document.getElementById("itemA").value = romaneio.quantidades[0];
            document.getElementById("itemB").value = romaneio.quantidades[1];
            document.getElementById("itemC").value = romaneio.quantidades[2];
            document.getElementById("itemH").value = romaneio.quantidades[3];
            document.getElementById("itemI").value = romaneio.quantidades[4];

          })
          .catch((error) => {
            console.log("Erro no carregamento de documento: "+ error);
          });

      }

      function excluirRomaneio() {

        excluirDocumento("romaneios", id);
        registrarMovimento(id, tipoMovimento.SAIDA);

      }

      function gerarIdRomaneio() {

        let data = document.getElementById("data").value;
        let placa = document.getElementById("placa").value;
        let itemA = document.getElementById("itemA").value;
        let itemB = document.getElementById("itemB").value;
        let itemC = document.getElementById("itemC").value;
        let itemH = document.getElementById("itemH").value;
        let itemI = document.getElementById("itemI").value;

        return Date.parse(data)
          .toString()
          .slice(0,6)
          .concat(placa.replace('-',''),
          (!!eval(itemA)
          + !!eval(itemB)
          + !!eval(itemC)
          + !!eval(itemH)
          + !!eval(itemI)));

      }

      //function registrarMovimento(romaneioId, tipoMovimento) {
      function registrarMovimento(romaneio) {

        console.log("[REGISTRAR MOVIMENTO]");

        console.log(romaneio);

        romaneio.quantidades.forEach((value, index, array) => {

          if(!!value) {

            let movimento = {
              data: romaneio.data, 
              origem: "romaneios/" + romaneio.id,
              destino: romaneio.placa,
              situacaoVasilhame: index,
              quantidade: value  
            }

            console.log("movimento:");
            console.log(movimento);


            criarDocumento("movimentos", movimento)
            .then((docRef) => {

                movimento.id = docRef;

                habilitarMonitoramentoDocumento("movimentos", docRef, function() {
                  console.log("listener movimento executando");
                  atualizarInventario(inventario, movimento);
                });  
                
            })

          }

        })
      
      }

    </script>

  </body>
</html>
